```{r pressure, echo=TRUE,fig.width = 8, fig.height=5}



# Kalman filter

Kalm_f<-function( TTT,R,Q,Z,H,W,data) {
  
  # Auxiliary
  y=data
  aux=dim(y)
  TT=aux[1] # number of periods
  dimZ=aux[2] # number of observables
  
  dimS=dim(TTT)
  dimS=dimS[1] # dimension of the state
  
  # Outputs
  Pred_a_st<-list()
  Pred_P_st<-list()
  Upd_a_st<-list()
  Upd_P_st<-list()
  vt=matrix(rep(0,dimZ*TT),TT,dimZ)
  Ft<-list()
  
  # Initialization
  
  a0=matrix(rep(0, dimS),dimS,1)
  RQRvec = as.vector(R%*%Q%*%t(R))    ## Vectorize
  P0=solve(diag(dimS^2)-kronecker(TTT,TTT)) %*% RQRvec
  P0=matrix(P0,dimS,dimS)
  
  # Period 1

  Pred_a=TTT%*%a0   ## Matrix Multiplication
  Pred_P=TTT%*%P0%*%t(TTT)+R%*%Q%*%t(R)
  vt[1,]=y[1,]-Z%*%Pred_a-W
  F=Z%*%Pred_P%*%t(Z)+H
  Ft[[1]]=F
  if (abs(det(F))<1e-20) {
    error=1
  return(error)
} else {
  invF=solve(F)
  
  Upd_a=Pred_a+Pred_P%*%t(Z)%*%invF%*%vt[1,]
  Upd_P=Pred_P-Pred_P%*%t(Z)%*%invF%*%Z%*%Pred_P
  
}
  
  Pred_a_st[[1]]=Pred_a
  Pred_P_st[[1]]=Pred_P
  Upd_a_st[[1]]=Upd_a
  Upd_P_st[[1]]=Upd_P
  

  # Following periods

for (t in 2:TT) {

  Pred_a=TTT%*%Upd_a   ## MAtrix Multiplication
  Pred_P=TTT%*%Upd_P%*%t(TTT)+R%*%Q%*%t(R)
  vt[t,]=y[t,]-Z%*%Pred_a-W
  F=Z%*%Pred_P%*%t(Z)+H
  Ft[[t]]=F
  if (abs(det(F))<1e-20) {
    error=1
    return(error)
  }  else {
  
  invF=solve(F)
  Upd_a=Pred_a+Pred_P%*%t(Z)%*%invF%*%vt[t,]
  Upd_P=Pred_P-Pred_P%*%t(Z)%*%invF%*%Z%*%Pred_P
  
  Pred_a_st[[t]]=Pred_a
  Pred_P_st[[t]]=Pred_P
  Upd_a_st[[t]]=Upd_a
  Upd_P_st[[t]]=Upd_P

  }
  
}

  Output<-list(Pred_a_st,Pred_P_st,Upd_a_st,Upd_P_st,vt,Ft)
  return(Output)
  
}

# Kalman smoother

Kalm_sm<-function(TTT,R,Q,Z,H,W,data) {
  
  Filtered=Kalm_f(TTT,R,Q,Z,H,W,data)
  Pred_a_st=Filtered[[1]]
  Pred_P_st=Filtered[[2]]
  Upd_a_st=Filtered[[3]]
  Upd_P_st=Filtered[[4]]
  
  TT=dim(data)
  TT=TT[1]
  
  # Outputs
  
  Smo_a_st<-list()
  Smo_P_st<-list()
  
  
  #Period TT
  
  Smo_a=Upd_a_st[[TT]]
  Smo_P=Upd_P_st[[TT]]
  
  Smo_a_st[[TT]]=Smo_a
  Smo_P_st[[TT]]=Smo_P

  for (t1 in 1: (TT-1) ) {
    t = TT - t1 # range from TT-1 to 1
    J=Upd_P_st[[t]]%*%t(TTT)%*%solve(Pred_P_st[[t+1]])
    Smo_a=Upd_a_st[[t]]+J%*%(Smo_a_st[[t+1]]-Pred_a_st[[t+1]])   # fixed
    Smo_P=Upd_P_st[[t]]+J%*%(Smo_P_st[[t+1]]-Pred_P_st[[t+1]])%*%t(J) # fixed
    
    Smo_a_st[[t]]=Smo_a
    Smo_P_st[[t]]=Smo_P
    
  }  
  
  Output<-list(Smo_a_st,Smo_P_st)
  return(Output)
}


## Try (1 dimension state)
init = c(0.5,2,2,2)
TTT  = init[1] * matrix(1,1,1)
R    = init[2]  * matrix(1,1,1)
H    = diag(c(init[3],init[4]));  
Q    = 1;
Z    = c(1,1);
W    = c(0,0);
raw_data <- read.table("gdpplus.csv",sep=",",header=TRUE,skip=0)
data_TS  <- raw_data[41:236,c(1,5,6)]
GDE_mean    <- mean(data_TS$GRGDP_DATA)
GDI_mean    <- mean(data_TS$GRGDI_DATA)
data_demean <- cbind(data_TS$GRGDP_DATA-GDE_mean,data_TS$GRGDI_DATA-GDI_mean) 
data = data_demean

AA = Kalm_f(TTT,R,Q,Z,H,W,data)

## Try (2 dimension state)
init = c(0.5,2,2,2)
TTT  = init[1]  * diag(2)
R    = init[2]  * diag(2)
H    = diag(c(init[3],init[4]));  
Q    = matrix(c(2,1,1,2),2,2);
Z    = matrix(1,2,2);
W    = c(0,0);

AA2 = Kalm_f(TTT,R,Q,Z,H,W,data)
AA3 = Kalm_sm(TTT,R,Q,Z,H,W,data)


```



